@using JXTNext.Sitefinity.Widgets.Job.Mvc.Models
@model JobDetailsViewModel
@using Telerik.Sitefinity.Frontend.SocialShare.SocialShareHelpers

@using System.Collections.Specialized;
@using Telerik.Sitefinity.Frontend.Mvc.Helpers;
@using Telerik.Sitefinity.Web;

@using JXTNext.Sitefinity.Common.Helpers

@{
    var isUserLoggedIn = JXTNext.Sitefinity.Common.Helpers.SitefinityHelper.IsUserLoggedIn();
    var isMemberUser = false;
    if (isUserLoggedIn)
    {
        isMemberUser = JXTNext.Sitefinity.Common.Helpers.SitefinityHelper.IsUserLoggedIn("Member");
    }

    TempData["JobTitleTemp"] = Model.JobDetails.Title;

}

@if (Model != null)
{

    List<string>
    classificationsDisplay = new List<string>
        ();
    foreach (var item in @Model.Classifications.Keys)
    {
        string hrefLink = "/jobs/advancedsearch/search-result" + string.Format("{0}?Filters[0].rootId={1}&Filters[0].values={2}", @ViewBag.JobResultsPageUrl, @Model.ClassificationsRootName, @item.ToString());

        classificationsDisplay.Add(@"<a href="" " + hrefLink + @" "" title="" " + Model.Classifications[item] + @" "">" + Model.Classifications[item] + @"</a>");
    }


    <div class="col-12 mt-5">

        <p class="new-serch">
            <a href="/job/advancedsearch" title="New search">New search   </a>&nbsp;&nbsp;
            <a href="/job-seekers/search-results" id="back-to-results" role="button" title="Back to results"> Back to results</a>
        </p>

        @*<nav class="mt-5" aria-label="breadcrumb">
                <ul>
                    <li><a href="#"> > New Search</a></li>
                    <li><a href="#"> > Back to results</a></li>
                </ul>
            </nav>*@
        <!-- breadcrumb/ -->
    </div>
    <p style="display:none" class="comapny-name-hiiden">@Model.JobDetails.CustomData["CompanyName"]</p>
    @*<p>@Newtonsoft.Json.JsonConvert.SerializeObject(Model)</p>*@
    <div class="job-detail col-12 col-sm-12 col-md-8">
        <div class="border rounded p-4 mb-4">

            <img src="" class="float-right"
                 alt="">
            <h2 class="mt-2">@Model.JobDetails.Title</h2>


            <ul class="border border-top-0 border-right-0 border-left-0 pb-4">
                @if (!string.IsNullOrEmpty(Model.JobDetails.CustomData["Bulletpoints.BulletPoint1"]))
                {
                    <li>@Model.JobDetails.CustomData["Bulletpoints.BulletPoint1"]</li>
                }
                @if (!string.IsNullOrEmpty(Model.JobDetails.CustomData["Bulletpoints.BulletPoint2"]))
                {
                    <li>@Model.JobDetails.CustomData["Bulletpoints.BulletPoint2"]</li>
                }
                @if (!string.IsNullOrEmpty(Model.JobDetails.CustomData["Bulletpoints.BulletPoint3"]))
                {
                    <li>@Model.JobDetails.CustomData["Bulletpoints.BulletPoint3"]</li>
                }
            </ul>

            <ul class="inline-list p-0 mb-4 location-hover">


                @*Sydney*@

                @{
                    var location = "";
                }
                @foreach (var item in @Model.Locations.Keys)
                {
                    location = (string)@Model.Locations[item];
                }
                <li class="mr-5"><img src="/ResourcePackages/BaySide/assets/images/location.png"><div>@Model.JobDetails.CustomData["CountryLocationArea[0].Filters[0].Value"] > @location</div></li>
                <li class="mr-5"> <img src="/ResourcePackages/BaySide/assets/images/doller.png"> <div>@Model.JobDetails.CustomData["Salary.Filters[0].Value"]</div></li>
                <li class="mr-5 clock-icon"><i class="fa fa-clock-o"></i><div> @Model.JobDetails.CustomData["WorkType.Filters[0].Value"]</div></li>
            </ul>



            @{
                string cleanContent = GeneralHelper.RemoveInlineStyling((string)Model.JobDetails.Description);
            }
            <p>
                @Html.HtmlSanitize((string)cleanContent)
            </p>

            <div class="sm-text">
                @Html.Raw(String.Join("<span>&gt;</span>&nbsp;", classificationsDisplay))
            </div>

        </div>

        <div class="job-offer-apply">
            <div class="job-apply-btn">
            </div>
        </div>
        <div class="job-expired-btn" style="width:100%">
        </div>

        @*<a href="@ViewBag.JobApplicationPageUrl/@Model.ClassificationsSEORouteName/@Model.JobDetails.JobID" class="btn btn-outline-primary btn-block mt-4">Apply now</a>*@
    </div>
    <!--END: job_details -->

    <aside class="job-sidebar col-12 col-sm-12 col-md-4 pl-lg-4">

        @*<a href="@ViewBag.JobApplicationPageUrl/@Model.ClassificationsSEORouteName/@Model.JobDetails.JobID" class="btn btn-outline-primary d-md-block d-none">Apply now</a>*@
        <div class="job-offer-apply">
            <div class="job-apply-btn hidden-xs">
            </div>
        </div>
        <div class="job-expired-btn" style="width:100%">
        </div>
        <h3 class="mt-4 h3-heading">Interested in this job?</h3>

        <ul class="inline-list p-0 mb-4">
            @*
                <li class="mr-3"><a class="action-link save-job" data-jobid="@Model.JobDetails.JobID" href="#"><i class="fa fa-save"></i> <span>Save</span></a></li>*@
            @*
                <li><a href="#" class="save-job" data-jobid="@Model.JobDetails.JobID"><em class="far fa-save"></em><span class="save-status-txt">Save this job</span></a></li>*@
            <li class="mr-3 save-job-wrapper"><!-- save job link is generated by ajax on the base of login status --></li>
            <li class="mr-3"><a class="action-link" href="javascript:window.print();"><i class="fa fa-print"></i> <span>Print</span></a></li>
            @*
                <li><a href="javascript:window.print();"><em class="fas fa-print"></em>Print this job</a></li>*@

            <li class="mr-3"><a class="action-link" href="/jobs/email-job?JobId=@Model.JobDetails.JobID"><i class="fa fa-envelope"></i> <span>Email</span></a></li>
            @*
                <li>
                    <a href="@ViewBag.EmailJobPageUrl?JobId=@Model.JobDetails.JobID" title="Tell a friend">
                        <em class="fas fa-envelope"></em>Email this job
                    </a>
                </li>*@
        </ul>

    </aside>


}

<script type="text/javascript">
            $(document).ready(function () {

                $('.job-detail ul').each(function (i, obj) {
                    var className = $(this).attr('class');
                    if (className != undefined && className != "") {
                        if (className.indexOf('location-hover') < 0)
                            $(this).addClass('ul-custom');
                    }
                    else
                        $(this).addClass('ul-custom');
                });


                if ($('p.comapny-name-hiiden').html().toLowerCase() == "alitis")
                    $('img.float-right').attr("src", "/ResourcePackages/BaySide/assets/images/brand/logo/alitis-logo.png");
                else if ($('p.comapny-name-hiiden').html().toLowerCase() == "austra health")
                    $('img.float-right').attr("src", "/ResourcePackages/BaySide/assets/images/brand/logo/austra-health-logo.png");
                else if ($('p.comapny-name-hiiden').html().toLowerCase() == "bayside group")
                    $('img.float-right').attr("src", "/ResourcePackages/BaySide/assets/images/brand/logo/bayside-group-automotive-logo.png");
                else if ($('p.comapny-name-hiiden').html().toLowerCase() == "bayside personnel")
                    $('img.float-right').attr("src", "/ResourcePackages/BaySide/assets/images/brand/logo/bayside-personnel-logo.png");
                else if ($('p.comapny-name-hiiden').html().toLowerCase() == "baytech")
                    $('img.float-right').attr("src", "/ResourcePackages/BaySide/assets/images/brand/logo/baytech-logo.png");
                else if ($('p.comapny-name-hiiden').html().toLowerCase() == "bridge consulting")
                    $('img.float-right').attr("src", "/ResourcePackages/BaySide/assets/images/brand/logo/bridge-consulting-logo.png");
                else if ($('p.comapny-name-hiiden').html().toLowerCase() == "cozWine")
                    $('img.float-right').attr("src", "/ResourcePackages/BaySide/assets/images/brand/logo/cozwine-logo.png");
                else if ($('p.comapny-name-hiiden').html().toLowerCase() == "techstaff")
                    $('img.float-right').attr("src", "/ResourcePackages/BaySide/assets/images/brand/logo/techstaff-logo.png");
                else if ($('p.comapny-name-hiiden').html().toLowerCase() == "payments &amp;amp; cards network")
                    $('img.float-right').attr("src", "https://teampcn.jxtnext.net/ResourcePackages/PCN/assets/dist/images/logo.png");


                //$('h1.fadeInUp, div.hero-title').html('Apply for Job @Model.JobDetails.Title');
                document.title = '@Model.JobDetails.Title';
                var isLoggedIn = '@isUserLoggedIn';

                var jobId = @Model.JobDetails.JobID;

                //ajax call for apply job button
                $.ajax({
                    type: 'POST',
                    cache: false,
                    url: $(location).attr('pathname') + "/IsJobApplied",
                    data: { JobId: jobId },
                    dataType: 'Json',
                    success: function (response) {
                        if (response.IsJobExpired == true) {
                            $('.job-mini').addClass('disabled-block');
                            $('.job-expired-btn').html('<div id="job-applied-msg" class="alert alert-danger" >Job expired.</div>');
                        }
                        if (response.IsJobApplied == true) {
                            $('.job-apply-btn').html('<div id="job-applied-msg" class="alert alert-info" >Job already applied.</div>');
                        }
                        else {
                            if (response.IsJobExpired == false) {
                                $('.job-apply-btn').html('<a id="job-application-lnk" class="btn btn-outline-primary btn-block" href="@ViewBag.JobApplicationPageUrl/@Model.ClassificationsSEORouteName/@Model.JobDetails.JobID?source=@Model.UrlReferral">Apply now</a>');
                            }
                        }
                    },
                    error: function (response) {
                    }
                });

                //ajax call for member logged in status
                $.ajax({
                    type: 'POST',
                    cache: false,
                    url: $(location).attr('pathname') + '/IsJobSaved',
                    data: { JobId: jobId },
                    dataType: 'Json',
                    success: function (response) {
                        if (response.IsUserLogged == true) {
                            $('li.save-job-wrapper').html('<a href="#" class="save-job" data-jobid="@Model.JobDetails.JobID"><i class="fa fa-save"></i><span class="save-status-txt">Save</span></a>');
                            if (response.IsJobSaved == true) {
                                var selfJob = $('.save-job');
                                $(selfJob).addClass("saved");
                                $(selfJob).find('.save-status-txt').text("Job saved");
                                $(selfJob).attr('data-savedjobid', response.SavedJobId);
                            }
                        }
                    },
                    error: function (response) {

                    }
                });


                //checking user logged in is member role
                $('#job-application-lnk').click(function (e) {
                    if (isLoggedIn.toLocaleLowerCase() == "true") {
                        var isMember = '@isMemberUser';

                        if (isMember.toLocaleLowerCase() != "true") {
                            e.preventDefault();
                            alert('Please login as Member to apply for this job.');
                        }
                    }
                });

                processSavedJobs();

                function processSavedJobs() {
                    var parm = {};
                    var urlPath = $(location).attr('pathname') + "/GetAllSavedJobs";
                    var self = $(this);
                    $.ajax({
                        type: 'POST',
                        cache: false,
                        url: urlPath,
                        data: parm,
                        dataType: 'Json',
                        success: function (response) {

                            if (response.Success == true) { // Getting the all saved jobs
                                $('.save-job').each(function () {
                                    var jobid = $(this).data('jobid');
                                    var selfJob = $(this);

                                    $.each(response.SavedJobs, function (index, saveJobInfo) {

                                        if (saveJobInfo.JobId == jobid) {

                                            $(selfJob).addClass("saved");
                                            $(selfJob).find('.save-status-txt').text("Job saved");
                                            $(selfJob).attr('data-savedjobid', saveJobInfo.SavedJobId);
                                        }
                                    });
                                });
                            }
                            else { // Job failed to save

                            }
                        },
                        error: function (response) { // Error
                        }
                    });


                };


                $(document).on('click', '.save-job', function (e) {
                    e.preventDefault();
                    var unSaveJob = false;
                    var ajaxActionName = "/SaveJob";
                    var jobid = $(this).data('jobid');
                    if ($(this).hasClass('saved')) {
                        unSaveJob = true;
                        ajaxActionName = "/RemoveSavedJob";
                        jobid = $(this).data('savedjobid');
                    }

                    var parm = { JobId: jobid };
                    var urlPath = $(location).attr('pathname') + ajaxActionName;
                    var self = $(this);
                    $.ajax({
                        type: 'POST',
                        cache: false,
                        url: urlPath,
                        data: parm,
                        dataType: 'Json',
                        success: function (response) {

                            if (response.Success == true) { // Job Saved or unsaved
                                if (unSaveJob) { // Unsave job
                                    self.removeClass("saved");
                                    self.find('.save-status-txt').text("Save job");
                                }
                                else { // Save job
                                    self.addClass("saved");
                                    self.find('.save-status-txt').text("Job saved");
                                }
                            }
                            else { // Job failed to save or unsave
                                if ((response.Errors[0].indexOf("(401)") > -1) || (response.Errors[0].indexOf("(403)") > -1))
                                    alert("Please login as a member to save a job.");
                                else
                                    alert(response.Errors[0]);
                            }
                        },
                        error: function (response) { // Error
                        }
                    });
                });

                if (document.referrer != "") {
                    var previousUrl = new URL(document.referrer);
                    var urlPath = previousUrl.pathname + previousUrl.search
                    $("#back-to-results").attr("href", urlPath);
                }
            });
</script>

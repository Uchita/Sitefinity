@{
    ViewBag.Title = "JobTemplate";

    JobTemplateLogoMap defaultSetting = Model.Mappings.Where(c => c.isDefaultSetting).FirstOrDefault();
}
@using JXTPosterTransform.Library.Models
@model JobTemplateLogoMappingModel
@{
    Html.RenderPartial("~/Views/Mappings/_MappingsNavigation2.cshtml");
}
<div class="">
    <h1 class="page-header">
        Job Template Logos</h1>
    <div class="pull-right">
        <span class="pull-right btn btn-success fileinput-button">
            <!-- The file input field used as target for the file upload widget -->
            <input id="fileupload" type="file" name="files[]" />
        </span>
        <div class="clearfix">
        </div>
        <p>
            <i>Accepts xls &amp; xlsx only. First column will be imported.</i></p>
    </div>
    <div class="clearfix">
    </div>
    @Html.Raw(TempData["Message"])
    @Html.Raw(ViewBag.Message)
    <div id="jsMessage">
    </div>
</div>
<form method="post" action="@Request.Url" onsubmit="return ValidateMappingSelection(this);">
<table id="dataTable" class="table table-striped table-bordered table-hover dataTable no-footer">
    <thead>
        <tr>
            <th>
                From Job Template Logo Value
            </th>
            <th>
                JXT Job Template Logo <a href="javascript:void(0)" class="pull-right" onclick="SortByJobTemplateLogo()">
                        <i class="fa fa-sort-alpha-asc"></i></a>
            </th>
            <th>
                JXT Job Template Logo ID
            </th>
            <th>
                Actions
            </th>
        </tr>
    </thead>
    <tbody>
        @{ int counter = 0; }
        @if (Model.Mappings == null || Model.Mappings.Count() == 0)
        {
            <tr class="dataRow">
                <td>
                    <input type="text" name="submit[@(counter)].ClientJobTemplateLogoID" class="form-control" value="" placeholder="Job template logo mapping" />
                    @Html.ValidationMessage("submit[" + counter + "].ClientJobTemplateLogoID")
                </td>
                <td>
                    <select name="submit[@(counter)].MapToJobTemplateLogoID" class="form-control mappingSelect" onchange="UpdateIDFromDropDown(this, '.idDisplay'); MappingSelectOnChange(this);">
                        <option value="-1">Please select...</option>
                        @if (Model.availableJobTemplateLogos != null)
                        {
                            foreach (JobTemplateLogoAvailable w in Model.availableJobTemplateLogos)
                            {
                            <option value="@w.MapToJobTemplateLogoID">@w.MapToJobTemplateLogoDescription</option>
                            }
                        }
                    </select>
                </td>
                <td class="idDisplay">
                </td>
                <td>
                    <button type="button" class="btn btn-danger" onclick="ClearDataRow(this);">
                        Clear</button>
                </td>
            </tr>
                        counter++;
        }
        else
        {
            foreach (JobTemplateLogoMap m in Model.Mappings)
            {
            <tr class="dataRow">
                <td>
                    <input type="text" name="submit[@(counter)].ClientJobTemplateLogoID" class="form-control" value="@m.ClientJobTemplateLogoID"/>
                    @Html.ValidationMessage("submit[" + counter + "].ClientJobTemplateLogoID")
                </td>
                <td>
                    <select name="submit[@(counter)].MapToJobTemplateLogoID" class="form-control mappingSelect" onchange="UpdateIDFromDropDown(this, '.idDisplay'); MappingSelectOnChange(this);">
                        <option value="-1">Please select...</option>
                        @if (Model.availableJobTemplateLogos != null)
                        {
                            foreach (JobTemplateLogoAvailable w in Model.availableJobTemplateLogos)
                            {
                            <option value="@w.MapToJobTemplateLogoID" @(new MvcHtmlString(m.MapToJobTemplateLogoID == w.MapToJobTemplateLogoID ? @"selected=""selected""" : string.Empty))>@w.MapToJobTemplateLogoDescription</option>
                            }
                        }
                    </select>
                </td>
                <td class="idDisplay">
                    @m.MapToJobTemplateLogoID
                </td>
                <td>
                    <button type="button" class="btn btn-danger" onclick="ClearDataRow(this);">
                        Clear</button>
                </td>
            </tr>
                        counter++;
            }
        }
        @*<tr class="dataRow defaultRow">
            <td class="text-right">
                Default Mapping
            </td>
            <td>
                <select name="submit[@(counter)].MapToJobTemplateLogoID" class="form-control" onchange="UpdateIDFromDropDown(this, '.idDisplay')">
                    <option value="-1">Please select...</option>
                    @foreach (JobTemplateLogoAvailable w in Model.availableJobTemplateLogos)
                    {
                        <option value="@w.MapToJobTemplateLogoID" @(new MvcHtmlString(defaultSetting != null && defaultSetting.MapToJobTemplateLogoID == w.MapToJobTemplateLogoID ? @"selected=""selected""" : string.Empty))>@w.MapToJobTemplateLogoDescription</option>
                    }
                </select>
            </td>
            <td class="idDisplay">
                @(defaultSetting != null ? defaultSetting.MapToJobTemplateLogoID.ToString() : "-")
            </td>
            @{
                counter++;
            }
        </tr>*@
        <tr>
            <td colspan="4" class="text-right">
                <a href="javascript:void(0)" class="btn btn-default" onclick="AddNewTypeRow('#dataTable', rowCounter)">
                    + Add Row</a>
            </td>
        </tr>
    </tbody>
</table>
<button type="submit" class="btn btn-primary">
    Submit Mappings</button>
</form>
@section Scripts
{
    <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
    <script type="text/javascript" src="/scripts/FileUploader/js/vendor/jquery.ui.widget.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script type="text/javascript" src="/scripts/FileUploader/js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script type="text/javascript" src="/scripts/FileUploader/js/jquery.fileupload.js"></script>
    <script src="/Scripts/main.js" type="text/javascript"></script>
    <script type="text/javascript">
        var rowCounter = @(counter);

        
        function SortByJobTemplateLogo()
        {
            var dataStore = new Array();
            for(var i=0;i<rowCounter;i++)
            {
                var newDataRow = { mapJTID: $("input[name='submit[" + i + "].ClientJobTemplateLogoID']").val(), JTName:$("select[name='submit[" + i + "].MapToJobTemplateLogoID'] option:selected").text(), JTID: $("select[name='submit[" + i + "].MapToJobTemplateLogoID']").val() };              
                dataStore.push(newDataRow);
            }

            dataStore.sort(
            function(a,b){ 
                return a.JTName.localeCompare(b.JTName);            
            });

            for(var i=0;i<rowCounter;i++)
            {
                var thisDataRow = dataStore[i];

                $("input[name='submit[" + i + "].ClientJobTemplateLogoID']").val(thisDataRow.mapJTID);
                $("select[name='submit[" + i + "].MapToJobTemplateLogoID']").val(thisDataRow.JTID).change();
            }
        }


        $(function () {
            'use strict';
            // Change this to the location of your server-side upload handler:
            var url = '/mappings/exceluploadprocessor';

            $('#fileupload').fileupload({
                url: url,
                dataType: 'json',
                sequentialUploads: true,
                done: function (e, data) {
                    var responseData = data.jqXHR.responseJSON;

                    if (responseData.Success) {

                        $.each(responseData.rowData, function (idx, data) {

                            var thisRowCounter = rowCounter;
                            AddNewTypeRow('#dataTable', rowCounter);

                            //modify the data
                            $("input[name='submit[" + thisRowCounter + "].ClientJobTemplateLogoID']").val(data.str1);

                            $("select[name='submit[" + thisRowCounter + "].MapToJobTemplateLogoID']").val("-1").change();

                        });

                    }
                    else {

                        var msg = $("<div></div>").addClass("alert alert-warning").html(responseData.Message);

                        $("#jsMessage").html(msg);

                    }

                }
            });
        });    </script>
}
